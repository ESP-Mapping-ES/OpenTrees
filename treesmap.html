<!doctype html>
<html>
<head>
  <meta charset='utf-8'>
  <script src="https://api.tiles.mapbox.com/mapbox.js/v1.6.4/mapbox.js"></script>
  <script src="http://code.jquery.com/jquery-1.11.2.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-54473923-6', 'auto');
    ga('send', 'pageview');

  </script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

  <link rel="shortcut icon" href="http://tree111.png"/>
  <!-- favicon: made by http://www.flaticon.com/authors/freepik, CC-BY 3.0 -->

  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

  <link href="https://api.tiles.mapbox.com/mapbox.js/v1.6.4/mapbox.css" rel="stylesheet" />
  <style>
    #banner {
      width:100%;
      height:150px;
    }
    body,html { width: 100%; height: 100%; }
    #map { 
      width: 100%;
      height: calc(100% - 160px);
    }
    .map-tooltip {
      width: 320px;
      min-height:340px;
    }
    .map-tooltip table {
      position:absolute;
      top:75px;
    }
    .map-tooltip-content > b {
      font-size: 160%;
    }
    .map-tooltip-content > b i{
      display:block;
    }
    #wikibox {
      position:absolute;
      left:0;
      bottom:0;
      /*height:600px;
      width:400px;*/
    }
    #wikitext {
      width:300px;
      max-height:200px;
      overflow:scroll;
      background:#eee;
      opacity:0.9;
      font-size: 80%;
    }
    #wikitext h2 {
      font-size:20px;
    }
    #wikibox img,
    #wikitext {
        border:1px solid gray;
    }
    #wikibox img {
      width:300px;
    }
    #header {
      height:160px;
    }
    body { margin: 0;
      background: hsl(100,31%,67%);
    }
  </style>
  <title>Trees map</title>
</head>
<body>
  <div id="header" class="container">
  <div class="a">
    <h1>Opentrees.org â€“ 365,164 open data trees</h1>
    <p>Data published by the local government areas of Melbourne, Greater Geelong, Ballarat, Manningham, Wyndham, Colac-Otways and Corangamite. You can find the raw data on <a href="http://data.gov.au">data.gov.au</a> and <a href="http://data.melbourne.vic.gov.au">data.melbourne.vic.gov.au</a>. To contribute, follow the standards at <a href="http://opencouncildata.org/">opencouncildata.org</a>. Click a tree for a Wikipedia image!</p>
    <small>Made by <a href="http://stevebennett.me">Steve Bennett</a> (<a href="stevage@gmail.com">email</a>, <a href="http://twitter.com/stevage1">Twitter</a>) for <a href="http://au.okfn.org/">Open Knowledge Australia</a>.</small>

  </div>
  </div>
  <div id="map"></div>
  <div id="wikibox">
    <div id="wikiimg"></div>
    <div id="wikitext"></div>
  </div>

  <script>
    
    function toSpeciesCase(str) {
      str = str.replace(/\s+Sp./i, '');
      str = str.replace(/\s+Cultivar/, '');
      str = str.replace(/\s+'.*$/g, '');
      return str.toLowerCase().replace(/^w\w/, function (txt) { return txt.toUpperCase(); });
    }

    
    var base = "http://guru.cycletour.org:80/tilelive/",

        mapName = "supertrees_f882c6";
    var map;    
    $.getJSON(base + mapName + ".json", {}, function(tilejson) {
      //tilejson.grids[0] = "http://guru.cycletour.org/tile/supertrees/{z}/{x}/{y}.grid.json";
      map = L.mapbox.map('map', tilejson, { 
        zoom: 12,
        maxZoom: L.Browser.retina ? 15 : 16, 
        minZoom: 8,
        tileLayer: { 
          detectRetina: true
          }
      });
      osmtrees = L.tileLayer('http://guru.cycletour.org/tile/osmtrees/{z}/{x}/{y}.png');
      L.control.layers([], {"OpenStreetMap trees": osmtrees}).addTo(map);
      map.setView(L.latLng(-38, 144), 9);
      map.gridLayer.on('click',function(e) { 
        // e.data has what we clicked on
        if (e.data && e.data.genus) {
          // &origin=guru.cycletour.org - how to make the HTTP headers match up?
          var wikiapi = 'http://en.wikipedia.org/w/api.php?action=query&format=json';
          var textapi = wikiapi + '&prop=extracts&redirects&titles=';
          var imageapi = wikiapi + '&prop=pageimages&redirects&titles=';
          var species = toSpeciesCase(e.data.genus + (e.data.species ? " " + e.data.species : ""));
          console.log('Searching Wikipedia for: ' + species);
          $.ajax(imageapi + encodeURIComponent(species), { dataType: 'jsonp', success: function(wikijson) {
            pages = wikijson.query.pages;
            page = pages[Object.keys(pages)[0]];
            if (page && page.thumbnail && page.thumbnail.source) {
              thumb = page.thumbnail.source.replace(/\/\d\dpx-/, L.Browser.retina ? '/600px-' : '/300px-');
              $("#wikiimg").html('<img src="' + thumb + '"/>');
              $("#wikiimg").append('<p><small><a href="https://en.wikipedia.org/wiki/File:' +page.pageimage + '">Source: Wikipedia. Click for attribution and licence.</a></small></p>');
            }
          }});
          $.ajax(textapi + encodeURIComponent(species), { dataType: 'jsonp', success: function(wikijson) {
            pages = wikijson.query.pages;
            page = pages[Object.keys(pages)[0]];
            if (page && page.extract) {
              $("#wikitext").html(page.extract +
                '<p><small>Source: <a href="http://en.wikipedia.org/wiki/' + encodeURIComponent(page.title) + '">Wikipedia</a></small></p>');
              $("#wikitext").show();
            } else {
              // not found
              $("#wikiimg").html('');
              $("#wikitext").html('Nothing on Wikipedia.');
            }
          }});
          
        }
      });
    });
      
  </script>
</body>
</html>