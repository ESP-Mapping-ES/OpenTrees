<!doctype html>
<html>
<head>
  <meta charset='utf-8'>
  <script src="https://api.tiles.mapbox.com/mapbox.js/v1.6.4/mapbox.js"></script>
  <script src="http://code.jquery.com/jquery-1.11.2.min.js"></script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-54473923-6', 'auto');
    ga('send', 'pageview');

  </script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

  <link rel="shortcut icon" href="http://tree111.png"/>
  <!-- favicon: made by http://www.flaticon.com/authors/freepik, CC-BY 3.0 -->

  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
  <script src="http://use.edgefonts.net/lancelot;neuton;lato.js"></script>


  <link href="https://api.tiles.mapbox.com/mapbox.js/v1.6.4/mapbox.css" rel="stylesheet" />
  <style>
    body,html { width: 100%; height: 100%; }
    #map { 
      width: 100%;
      height: calc(100% - 160px);
      border-top: 1px solid gray;
    }
    .map-tooltip {
      width: 260px;
      min-height:340px;
      background:#eee;
      border:1px solid #aaa;
    }
    .map-tooltip table {
      position:absolute;
      top:75px;
      max-width: 245px;
    }
    .map-tooltip-content > b {
      font-size: 24px;
      font-family: lancelot,"Helvetica Neue", Helvetica,Arial,sans-serif;
    }
    .map-tooltip-content > b i{
      display:block;
      font-size: 16px;
      color: #555;
    }

    .map-tooltip-content th {
      color: #555;
      padding-right:8px;
    }
    #wikibox {
      position:absolute;
      left:0;
      bottom:0;
      /*height:600px;
      width:400px;*/
    }
    #wikitext {
      width:300px;
      max-height:200px;
      overflow:scroll;
      background:#eee;
      opacity:0.9;
      font-size: 80%;
    }
    #wikitext h2 {
      font-size:20px;
    }
    #wikibox img,
    #wikitext {
        border:1px solid gray;
    }
    #wikitext h2 {
      font-family:lancelot;
      
      font-weight:600;
    }

    #wikibox img {
      width:300px;
    }
    #header {
      height:160px;
      font-family: lato, sans-serif;
    }
    #header h1 {
      font-family: lancelot, serif;
      font-size:44px;
      font-weight:600;
      margin-top:12px;
    }
    .header-title {
      color:hsl(120,60%,20%);
      /*border-bottom: 1px solid gray;*/
    }
    body { margin: 0;
      background: hsl(100,31%,70%);
    }
    a {
      color: hsl(120,80%,25%);
      font-weight: 600;
    }
    #logo {
      background-image: url('tree65.svg');
      background-size:contain;
      background-repeat:no-repeat;
      width:104px;
      height:100px;
      float:left;
      margin: 18px 4px;
    }

        /*<div>Icon made by <a href="http://www.freepik.com" title="Freepik">Freepik</a> from <a href="http://www.flaticon.com" title="Flaticon">www.flaticon.com</a> is licensed under <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0">CC BY 3.0</a></div>*/

  </style>
  <title>OpenTrees.org</title>
</head>
<body>
  <div class="container">
  <div id="logo"></div>
  <div id="header">
  <div class="a">
    <h1><span class="header-title">OpenTrees.org</span> &nbsp; <small>373,678 open data trees</small></h1>
    <p>Tree data from Melbourne, <a href="#geelong" onclick="doBookmarks('geelong')">Greater Geelong</a>, Ballarat, Manningham, Wyndham, Colac-Otways, Corangamite and <a href="#adelaide" onclick="doBookmarks('adelaide')">Adelaide</a>, plus the Waite Arboretum. You can find the raw data on <a href="http://data.gov.au">data.gov.au</a>, <a href="http://data.melbourne.vic.gov.au">data.melbourne.vic.gov.au</a> and <a href="http://data.sa.gov.au">data.sa.gov.au</a>. To contribute, follow the standards at <a href="http://opencouncildata.org/">opencouncildata.org</a>. Click a tree for a Wikipedia image!</p>
    <small>Made by <a href="http://stevebennett.me">Steve Bennett</a> (<a href="stevage@gmail.com">email</a>, <a href="http://twitter.com/stevage1">Twitter</a>) for <a href="http://au.okfn.org/">Open Knowledge Australia</a>. <a href="https://github.com/okfnau/treesmap">Source code</a>.</small>

  </div>
  </div>
  </div>
  <div id="map"></div>
  <div id="wikibox">
    <div id="wikiimg"></div>
    <div id="wikitext"></div>
  </div>

  <script>
    
    function toSpeciesCase(str) {
      str = str.replace(/\s+Sp./i, '');
      str = str.replace(/\s+Cultivar/i, '');
      str = str.replace(/\s+'.*$/g, '');
      return str.toLowerCase().replace(/^w\w/, function (txt) { return txt.toUpperCase(); });
    }

    function doBookmarks(bookmark) {
      bookmarks={ 
        "adelaide": { x: 138.6217, y: -34.9491, z: 13 },
        "melbourne": { x: 144.95, y: -37.8, z: 11 },
        "manningham": { x: 145.15, y: -37.77, z: 13},
        "geelong": { x: 144.5, y: -38.15, z: 11}
      };
      if (!bookmark) {
        var matches = window.location.href.match(/#([a-zA-Z0-9_-]+)/);
        if (matches) {
          bookmark = matches[1];
        }

      }
      if (b = bookmarks[bookmark]) {
        map.setView(L.latLng(b.y,b.x), b.z);
      }

    }

    if (window.location.href.match("embed")) {
      // cut down some chrome for embedding
      $("#header").hide();
      $("#map").css("height","100%");
    }

    
    var base = "http://guru.cycletour.org/tilelive/",
        mapName = "supertrees_f882c6";
        
    var map;    
    $.getJSON(base + mapName + ".json", {}, function(tilejson) {
      //tilejson.grids[0] = "http://guru.cycletour.org/tile/supertrees/{z}/{x}/{y}.grid.json";
      tilejson.grids[0] = 'http://guru.cycletour.org/treetiles/{z}/{x}/{y}.grid.json?updated=7';
      tilejson.tiles[0] = 'http://guru.cycletour.org/treetiles/{z}/{x}/{y}.png?updated=7';
      tilejson.maxzoom = 22;
      tilejson.minzoom = 8;
      delete tilejson.bounds;

      var treegrid = L.mapbox.gridLayer(tilejson);
      map = L.mapbox.map ('map', tilejson, {
        zoom: 12,
        tileLayer: { detectRetina: true }
      });

      var osmtrees = L.tileLayer("http://guru.cycletour.org/tile/osmtrees/{z}/{x}/{y}.png" );
      var interestingtrees = L.tileLayer("http://guru.cycletour.org/interesting/{z}/{x}/{y}.png?updated=7", {
        detectRetina:true} );

      L.control.layers(
        [], { "OpenStreetMap trees": osmtrees, "Interesting trees": interestingtrees},
        { "collapsed": false, position: "bottomright" }
        ).addTo(map);
      map.setView(L.latLng(-38, 144), 9);
      doBookmarks();

      map.gridLayer.on('click',function(e) { 
        // e.data has what we clicked on
        if (e.data && e.data.genus) {
          var wikiapi = 'http://en.wikipedia.org/w/api.php?action=query&format=json';
          var textapi = wikiapi + '&prop=extracts&redirects&titles=';
          var imageapi = wikiapi + '&prop=pageimages&redirects&titles=';
          var species = toSpeciesCase(e.data.genus + (e.data.species ? " " + e.data.species : ""));
          console.log('Searching Wikipedia for: ' + species);
          $.ajax(imageapi + encodeURIComponent(species), { dataType: 'jsonp', success: function(wikijson) {
            pages = wikijson.query.pages;
            page = pages[Object.keys(pages)[0]];
            if (page && page.thumbnail && page.thumbnail.source) {
              thumb = page.thumbnail.source.replace(/\/\d\dpx-/, L.Browser.retina ? '/600px-' : '/300px-');
              $("#wikiimg").html('<img src="' + thumb + '"/>');
              $("#wikiimg").append('<p><small><a href="https://en.wikipedia.org/wiki/File:' +page.pageimage + '">Source: Wikipedia. Click for attribution and licence.</a></small></p>');
            }
          }});
          $.ajax(textapi + encodeURIComponent(species), { dataType: 'jsonp', success: function(wikijson) {
            pages = wikijson.query.pages;
            page = pages[Object.keys(pages)[0]];
            if (page && page.extract) {
              $("#wikitext").html(page.extract +
                '<p><small>Source: <a href="http://en.wikipedia.org/wiki/' + encodeURIComponent(page.title) + '">Wikipedia</a></small></p>');
              $("#wikitext").show();
            } else {
              // not found
              $("#wikiimg").html('');
              $("#wikitext").html('Nothing on Wikipedia.');
            }
          }});
          
        }
      });
    });
      
  </script>
</body>
</html>